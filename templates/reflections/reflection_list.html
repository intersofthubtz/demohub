{% extends "base.html" %}
{% load static %}

{% block title %}Reflections{% endblock %}

{% block content %}
<div class="p-6 max-w-7xl mx-auto space-y-6">

  <!-- Page Header -->
  <h1 class="text-2xl font-bold text-[#0F5391]">Reflections</h1>

  <!-- ================= SUCCESS MESSAGES ================= -->
  {% if messages %}
  <div id="messages-container" class="space-y-2">
    {% for message in messages %}
      {% if message.tags == 'success' %}
      <div class="px-4 py-2 rounded bg-green-100 text-green-700 text-sm font-semibold">
        {{ message }}
      </div>
      {% endif %}
    {% endfor %}
  </div>
  {% endif %}

  <!-- ================= FILTERS + SEARCH ================= -->
  <form method="GET" class="bg-white p-4 rounded shadow flex flex-wrap items-center gap-4">

    <!-- Category Filter -->
    <div>
      <label class="block text-gray-700 font-medium mb-1">Category</label>
      <select name="category" class="border p-2 rounded">
        {% for c in categories %}
          <option value="{{ c }}" {% if selected_category == c %}selected{% endif %}>
            {{ c }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Search Bar -->
    <div>
      <label class="block text-gray-700 font-medium mb-1">Search</label>
      <input type="text" name="search" placeholder="Search title..."
             value="{{ search }}" class="border p-2 rounded w-64">
    </div>

    <!-- Action Buttons -->
    <div class="ml-auto flex gap-2 mt-4 sm:mt-0">
      <button type="submit" class="px-4 py-2 bg-[#0F5391] text-white rounded hover:bg-blue-700 transition">
        Filter
      </button>

      {% if perms.reflections.add_reflection %}
      <a href="{% url 'reflections:reflection_create' %}"
         class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">
        + Add Reflection
      </a>
      {% endif %}
    </div>

  </form>

  <!-- ================= REFLECTIONS TABLE ================= -->
  <div class="bg-white p-6 rounded shadow overflow-x-auto">
    {% if reflections %}
      <table class="w-full border-collapse border text-sm">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2 border">Title</th>
            <th class="p-2 border">Category</th>
            <th class="p-2 border">Author</th>
            <th class="p-2 border">Date</th>
            <th class="p-2 border">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for r in reflections %}
          <tr class="hover:bg-gray-50 transition">
            <td class="p-2 border">{{ r.title }}</td>
            <td class="p-2 border">{{ r.get_category_display }}</td>
            <td class="p-2 border">{{ r.author.username }}</td>
            <td class="p-2 border">{{ r.created_at|date:"M d, Y H:i" }}</td>
            <td class="p-2 border flex gap-2">
              {% if perms.reflections.view_reflection %}
              <a href="{% url 'reflections:reflection_detail' r.id %}" class="text-blue-600 hover:underline">View</a>
              {% endif %}

              {% if perms.reflections.change_reflection %}
              <a href="{% url 'reflections:reflection_edit' r.id %}" class="text-green-600 hover:underline">Edit</a>
              {% endif %}

              {% if perms.reflections.delete_reflection %}
              <a href="{% url 'reflections:reflection_delete' r.id %}" class="text-red-600 hover:underline">Delete</a>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- ================= PAGINATION ================= -->
      {% include "partials/pagination.html" with page_obj=reflections %}
    {% else %}
      <p class="text-gray-500 text-center py-10">No reflections found.</p>
    {% endif %}
  </div>

</div>

<!-- JS: Auto-hide success messages after 5 seconds -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const messagesContainer = document.getElementById("messages-container");
  if (messagesContainer) {
    setTimeout(() => {
      messagesContainer.style.transition = "opacity 0.5s";
      messagesContainer.style.opacity = 0;
      setTimeout(() => messagesContainer.remove(), 400);
    }, 5000);
  }
});
</script>

{% endblock %}
